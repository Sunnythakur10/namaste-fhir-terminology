<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Researcher Sandbox | NAMASTE-FHIR Terminology</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="/ui/assets/css/main.css">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- AG Grid for data tables -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css">
    <style>
        /* Additional styles specific to researcher page */
        .filter-ribbon {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            padding: 16px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }
        
        .chart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .toggle-group {
            display: flex;
            background-color: #f3f4f6;
            border-radius: 6px;
            padding: 4px;
        }
        
        .toggle-option {
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .toggle-option.active {
            background-color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            color: var(--primary-text-color);
        }
        
        .data-table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .export-strip {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .export-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 6px;
            background-color: #f3f4f6;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }
        
        .export-button:hover {
            background-color: #e5e7eb;
        }
        
        .system-badge {
            display: inline-flex;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .system-badge.namaste {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .system-badge.icd {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .system-badge.both {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        
        .trend-up {
            color: #10b981;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .trend-down {
            color: #ef4444;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Chart styling */
        #prevalence-chart {
            width: 100%;
            height: 300px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .loading-overlay.active {
            visibility: visible;
            opacity: 1;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="logo">NAMASTE-FHIR</div>
                <ul class="nav-menu">
                    <li><a href="/ui/pages/landing.html">Home</a></li>
                    <li><a href="/ui/pages/doctor-sandbox.html">Doctor Sandbox</a></li>
                    <li><a href="/ui/pages/researcher-sandbox.html" class="active">Researcher Sandbox</a></li>
                    <li><a href="/ui/pages/insurance-workflow.html">Insurance</a></li>
                    <li><a href="/ui/pages/api-docs.html">API Docs</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <section class="page-header">
                <h1>Researcher Sandbox</h1>
                <p>Query prevalence data and export results in various formats</p>
            </section>

            <section class="filter-ribbon">
                <div class="filter-item">
                    <span class="material-symbols-outlined">date_range</span>
                    <input type="text" id="date-range" placeholder="Date Range (Last 12 months)" class="form-input">
                </div>
                <div class="filter-item">
                    <span class="material-symbols-outlined">database</span>
                    <select id="system-toggle" class="form-select">
                        <option value="namaste">NAMASTE</option>
                        <option value="icd11">ICD-11</option>
                        <option value="both" selected>Both</option>
                    </select>
                </div>
                <div class="filter-item">
                    <span class="material-symbols-outlined">search</span>
                    <input type="text" id="term-search" placeholder="Search terms or codes..." class="form-input">
                </div>
            </section>

            <section class="chart-container">
                <div class="chart-header">
                    <div>
                        <h2>Top 20 Codes</h2>
                        <p class="text-muted">Last 12 Months</p>
                    </div>
                    <div class="toggle-group">
                        <label class="toggle-option active" id="percent-toggle">
                            <input type="radio" name="chart-view" value="percent" checked hidden>
                            %
                        </label>
                        <label class="toggle-option" id="count-toggle">
                            <input type="radio" name="chart-view" value="count" hidden>
                            Count
                        </label>
                    </div>
                </div>
                <canvas id="prevalence-chart"></canvas>
            </section>

            <section class="data-table-container">
                <div class="export-strip">
                    <button class="export-button" id="export-csv">
                        <span class="material-symbols-outlined">download</span>
                        CSV
                    </button>
                    <button class="export-button" id="export-fhir">
                        <span class="material-symbols-outlined">download</span>
                        FHIR JSON (ValueSet)
                    </button>
                    <button class="export-button" id="export-png">
                        <span class="material-symbols-outlined">download</span>
                        PNG Chart
                    </button>
                </div>
                <div id="prevalence-grid" class="ag-theme-alpine" style="height: 400px; width: 100%;"></div>
            </section>
        </div>
    </main>

    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script src="/ui/assets/js/main.js"></script>
    <script>
        // Initialize date picker (placeholder - would use a real date picker library in production)
        document.getElementById('date-range').addEventListener('click', function() {
            alert('Date picker would open here. In a real implementation, this would use a library like Flatpickr or DateRangePicker.');
        });

        // Toggle between percentage and count views
        document.getElementById('percent-toggle').addEventListener('click', function() {
            document.getElementById('percent-toggle').classList.add('active');
            document.getElementById('count-toggle').classList.remove('active');
            updateChart('percent');
        });

        document.getElementById('count-toggle').addEventListener('click', function() {
            document.getElementById('count-toggle').classList.add('active');
            document.getElementById('percent-toggle').classList.remove('active');
            updateChart('count');
        });

        // Sample data for demonstration
        const prevalenceData = {
            labels: [
                'Vata Dosha Imbalance', 'Pitta Dosha Imbalance', 'Kapha Dosha Imbalance',
                'Ama Accumulation', 'Agni Impairment', 'Prana Disruption',
                'Ojas Depletion', 'Tejas Imbalance', 'Soma Disruption',
                'Srotas Blockage', 'Dhatu Imbalance', 'Malas Disruption',
                'Gunas Imbalance', 'Prakriti Deviation', 'Vikriti State',
                'Sattva Deficiency', 'Rajas Excess', 'Tamas Excess',
                'Panchakarma Indication', 'Rasayana Need'
            ],
            percentages: [
                23, 19, 17, 15, 14, 12, 11, 10, 9, 8, 7, 6, 5, 4, 4, 3, 3, 2, 2, 1
            ],
            counts: [
                463, 384, 341, 302, 287, 245, 221, 198, 182, 167, 143, 129, 98, 85, 76, 65, 52, 45, 39, 28
            ],
            trends: [
                'up', 'down', 'up', 'down', 'up', 'up', 'down', 'down', 'up', 'up',
                'down', 'up', 'down', 'up', 'down', 'up', 'down', 'up', 'down', 'up'
            ]
        };

        // Initialize chart
        let prevalenceChart;
        function initChart() {
            const ctx = document.getElementById('prevalence-chart').getContext('2d');
            prevalenceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: prevalenceData.labels,
                    datasets: [{
                        label: 'Prevalence (%)',
                        data: prevalenceData.percentages,
                        backgroundColor: '#38e07b',
                        borderColor: '#38e07b',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Percentage (%)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Update chart based on view type
        function updateChart(viewType) {
            if (!prevalenceChart) return;
            
            if (viewType === 'percent') {
                prevalenceChart.data.datasets[0].data = prevalenceData.percentages;
                prevalenceChart.data.datasets[0].label = 'Prevalence (%)';
                prevalenceChart.options.scales.y.title.text = 'Percentage (%)';
            } else {
                prevalenceChart.data.datasets[0].data = prevalenceData.counts;
                prevalenceChart.data.datasets[0].label = 'Case Count';
                prevalenceChart.options.scales.y.title.text = 'Number of Cases';
            }
            prevalenceChart.update();
        }

        // Initialize AG Grid
        function initGrid() {
            // Create row data
            const rowData = prevalenceData.labels.map((label, index) => {
                // Generate random codes based on system
                const systemTypes = ['namaste', 'icd11', 'both'];
                const systemType = systemTypes[Math.floor(Math.random() * 3)];
                let code;
                
                if (systemType === 'namaste') {
                    code = 'N' + (Math.floor(Math.random() * 9000) + 1000);
                } else if (systemType === 'icd11') {
                    code = 'MG2' + (Math.floor(Math.random() * 90) + 10);
                } else {
                    code = 'DB' + (Math.floor(Math.random() * 900) + 100);
                }
                
                return {
                    term: label,
                    code: code,
                    system: systemType,
                    cases: prevalenceData.counts[index],
                    percentage: prevalenceData.percentages[index] + '%',
                    trend: prevalenceData.trends[index]
                };
            });

            // Define column definitions
            const columnDefs = [
                { field: 'term', headerName: 'Term', sortable: true, filter: true },
                { field: 'code', headerName: 'Code', sortable: true, filter: true },
                { 
                    field: 'system', 
                    headerName: 'System', 
                    sortable: true, 
                    filter: true,
                    cellRenderer: params => {
                        const system = params.value;
                        let badgeClass = '';
                        let displayText = '';
                        
                        if (system === 'namaste') {
                            badgeClass = 'system-badge namaste';
                            displayText = 'NAMASTE';
                        } else if (system === 'icd11') {
                            badgeClass = 'system-badge icd';
                            displayText = 'ICD-11';
                        } else {
                            badgeClass = 'system-badge both';
                            displayText = 'Both';
                        }
                        
                        return `<span class="${badgeClass}">${displayText}</span>`;
                    }
                },
                { field: 'cases', headerName: 'Cases', sortable: true, filter: 'agNumberColumnFilter' },
                { field: 'percentage', headerName: '%', sortable: true },
                { 
                    field: 'trend', 
                    headerName: 'Trend', 
                    sortable: true,
                    cellRenderer: params => {
                        const trend = params.value;
                        if (trend === 'up') {
                            return '<span class="trend-up"><span class="material-symbols-outlined">arrow_upward</span> Up</span>';
                        } else {
                            return '<span class="trend-down"><span class="material-symbols-outlined">arrow_downward</span> Down</span>';
                        }
                    }
                }
            ];

            // Create new grid instance
            new agGrid.Grid(document.getElementById('prevalence-grid'), {
                columnDefs: columnDefs,
                rowData: rowData,
                pagination: true,
                paginationPageSize: 10,
                domLayout: 'autoHeight',
                defaultColDef: {
                    flex: 1,
                    minWidth: 100,
                    resizable: true
                }
            });
        }

        // Show loading overlay
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }

        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }

        // Handle export buttons
        document.getElementById('export-csv').addEventListener('click', function() {
            showLoading();
            // Simulate API call delay
            setTimeout(() => {
                hideLoading();
                alert('CSV export would be downloaded here. In a real implementation, this would trigger a server-side export.');
            }, 1000);
        });

        document.getElementById('export-fhir').addEventListener('click', function() {
            showLoading();
            // Simulate API call delay
            setTimeout(() => {
                hideLoading();
                alert('FHIR ValueSet JSON would be downloaded here. This would be a standard FHIR resource.');
            }, 1000);
        });

        document.getElementById('export-png').addEventListener('click', function() {
            if (!prevalenceChart) return;
            const url = prevalenceChart.toBase64Image();
            const link = document.createElement('a');
            link.download = 'prevalence-chart.png';
            link.href = url;
            link.click();
        });

        // Handle search functionality
        document.getElementById('term-search').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            // In a real implementation, this would filter data or make a new API call
            alert(`Search functionality would filter data for: ${searchTerm}`);
        });

        // Handle system toggle
        document.getElementById('system-toggle').addEventListener('change', function(e) {
            const system = e.target.value;
            showLoading();
            // Simulate API call delay
            setTimeout(() => {
                hideLoading();
                alert(`Data would be filtered for system: ${system}`);
            }, 1000);
        });

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            initGrid();

            // Simulate initial data loading
            showLoading();
            setTimeout(hideLoading, 1000);
        });
    </script>
</body>
</html>
